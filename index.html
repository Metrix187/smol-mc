<!doctype html><body style=margin:0;overflow:hidden><canvas id=c style=width:100%;height:100%;image-rendering:pixelated><script>
  (function(){
  var C=c,X=C.getContext('2d'),W=C.width=256,H=C.height=192,M=Math,S=M.sin,O=M.cos,A=M.abs,F=M.floor,
  SZ=64,SZ2=SZ*SZ,map=new Uint8Array(SZ**3),px=32,py=60,pz=32,yaw=0,pit=-0.4,vx=0,vy=0,vz=0,K={},
  mx,my,mz,lx,ly,lz,face,id,sel=1;
  
  // Block Colors: 0:Empty, 1:Grass, 2:Dirt, 3:Stone, 4:Water
  var COLS = [[0,0,0],[100,200,50],[120,90,50],[140,140,140],[60,100,220]];
  
  // Generate Terrain
  for(var i=0;i<SZ;i++)for(var k=0;k<SZ;k++){
    var h=28+F(8*S(i/12)+6*O(k/10)+5*S((i+k)/8));
    for(var j=0;j<SZ;j++){
      var t=0;
      if(j<h) t=(j==h-1)?1:(j>h-5?2:3); 
      else if(j<34) t=4; 
      map[i+SZ*j+SZ2*k]=t;
    }
  }
  
  // Safety Spawn
  var spawnY=SZ-1;
  while(spawnY>0 && !map[32+SZ*spawnY+SZ2*32]) spawnY--;
  py = spawnY + 2.5;
  
  // Input
  onkeydown=e=>{ 
    K[e.keyCode]=1; 
    if(e.key=='r'||e.key=='R') { px=32; pz=32; py=spawnY+5; vy=0; } 
    if(e.key>0 && e.key<5) sel=+e.key;
  };
  onkeyup=e=>K[e.keyCode]=0;
  
  onmousemove=e=>{
    if(document.pointerLockElement){
      yaw+=e.movementX*0.003; 
      pit-=e.movementY*0.003;
      pit=M.max(-1.5,M.min(1.5,pit));
    }
  }
  
  onmousedown=e=>{
    if(!document.pointerLockElement) return C.requestPointerLock();
    ray(px,py,pz,yaw,pit,1); 
    if(id){
      var idx=mx+SZ*my+SZ2*mz, lidx=lx+SZ*ly+SZ2*lz;
      if(e.button==2 && !box(px,py,pz,lx,ly,lz) && id!=4) map[lidx]=sel; 
      if(e.button==0 && id!=4) map[idx]=0; 
    }
  }
  
  function box(x,y,z,bx,by,bz){return x>bx-0.3&&x<bx+1.3 && y>by-1.5&&y<by+0.5 && z>bz-0.3&&z<bz+1.3}
  function col(x,y,z){
    if(x<0||x>=SZ||y<0||y>=SZ||z<0||z>=SZ)return 1;
    var b=map[F(x)+SZ*F(y)+SZ2*F(z)];
    return (b&&b!=4);
  }
  function move(dx,dy,dz){
    if(!col(px+dx,py,pz-0.3)&&!col(px+dx,py,pz+0.3)&&!col(px+dx,py-1,pz-0.3)&&!col(px+dx,py-1,pz+0.3)) px+=dx; else vx=0;
    if(!col(px-0.3,py,pz+dz)&&!col(px+0.3,py,pz+dz)&&!col(px-0.3,py-1,pz+dz)&&!col(px+0.3,py-1,pz+dz)) pz+=dz; else vz=0;
    var yOff=dy>0?0:-1.5;
    if(!col(px-0.3,py+dy+yOff,pz-0.3)&&!col(px+0.3,py+dy+yOff,pz-0.3)&&!col(px+0.3,py+dy+yOff,pz+0.3)&&!col(px-0.3,py+dy+yOff,pz+0.3)) py+=dy; 
    else { if(dy<0)K.gr=1; vy=0; }
  }
  
  function ray(ox,oy,oz,ya,pi,act,uu,vv){
    var dx=S(ya)*O(pi), dy=S(pi), dz=O(ya)*O(pi);
    if(!act){
      var fov=.8, rX=O(ya), rZ=-S(ya), uX= -S(pi)*S(ya), uY=O(pi), uZ= -S(pi)*O(ya);
      dx = S(ya)*O(pi) + rX*uu*fov + uX*vv*fov*.75;
      dy = S(pi)       +      0      + uY*vv*fov*.75;
      dz = O(ya)*O(pi) + rZ*uu*fov + uZ*vv*fov*.75;
    }
    mx=F(ox); my=F(oy); mz=F(oz);
    if(map[mx+SZ*my+SZ2*mz] && !act) { id=map[mx+SZ*my+SZ2*mz]; return {d:0.1, dx:dx, dy:dy, dz:dz}; }
  
    var stepX=dx<0?-1:1, stepY=dy<0?-1:1, stepZ=dz<0?-1:1;
    var dX=A(1/dx), dY=A(1/dy), dZ=A(1/dz);
    var sdX=(stepX>0?mx+1-ox:ox-mx)*dX, sdY=(stepY>0?my+1-oy:oy-my)*dY, sdZ=(stepZ>0?mz+1-oz:oz-mz)*dZ;
    id=0; var dist=0; lx=mx; ly=my; lz=mz;
    while(dist<60){
      if(sdX<sdY && sdX<sdZ) { sdX+=dX; lx=mx; mx+=stepX; face=0; dist=sdX-dX; }
      else if(sdY<sdZ)       { sdY+=dY; ly=my; my+=stepY; face=1; dist=sdY-dY; }
      else                   { sdZ+=dZ; lz=mz; mz+=stepZ; face=2; dist=sdZ-dZ; }
      if(mx<0||mx>=SZ||my<0||my>=SZ||mz<0||mz>=SZ) break;
      var b=map[mx+SZ*my+SZ2*mz];
      if(b){ id=b; return {d:dist, dx:dx, dy:dy, dz:dz}; }
    }
    return {d:0, dx:dx, dy:dy, dz:dz};
  }
  
  setInterval(()=>{
    var fwd=K[87]?1:(K[83]?-1:0), strafe=K[68]?1:(K[65]?-1:0);
    vx += (S(yaw)*fwd + O(yaw)*strafe) * .02;
    vz += (O(yaw)*fwd - S(yaw)*strafe) * .02;
    vy -= .015; if(K[32] && K.gr) { vy=.25; K.gr=0; }
    move(vx,vy,vz); vx*=.8; vz*=.8;
  
    var img = X.createImageData(W,H), dt=img.data;
    for(var x=0; x<W; x+=2) for(var y=0; y<H; y+=2){
      var r=ray(px,py,pz,yaw,pit,0, (x/W-.5)*2, -(y/H-.5)*2);
      var dist=r.d, R=0,G=0,B=0;
      
      if(id){
        var hx=px+r.dx*dist, hy=py+r.dy*dist, hz=pz+r.dz*dist;
        var u=(face==0)?hz:(face==1?hx:hx), v=(face==1)?hz:hy;
        var pat = ((F(u*8)^F(v*8))&1) ? 0.85 : 1.0; 
        
        var col = COLS[id];
        if(id==1 && face!=1) col = COLS[2]; 
        
        var shad = 1/(dist*0.08+1);
        if(face==1) shad*=1.1; if(face==2) shad*=0.8;
        if(id==3) pat = ((F(hx*4)^F(hy*4)^F(hz*4))&1) ? 0.9 : 1; 
        
        R=col[0]*pat*shad; G=col[1]*pat*shad; B=col[2]*pat*shad;
      } else {
        var sun = M.pow(M.max(0, r.dx*0.2 + r.dy*0.9 + r.dz*0.2), 30);
        var sky = M.max(0, 1 - (r.dy+0.5)); 
        R = 100*sky + sun*255; 
        G = 180*sky + sun*255; 
        B = 255*sky + sun*200;
      }
      
      var idx = (x+y*W)*4;
      dt[idx]=R; dt[idx+1]=G; dt[idx+2]=B; dt[idx+3]=255;
      dt[idx+4]=R;dt[idx+5]=G;dt[idx+6]=B;dt[idx+7]=255;
      var idx2=idx+W*4;
      dt[idx2]=R;dt[idx2+1]=G;dt[idx2+2]=B;dt[idx2+3]=255;
      dt[idx2+4]=R;dt[idx2+5]=G;dt[idx2+6]=B;dt[idx2+7]=255;
    }
    X.putImageData(img,0,0);
    
    // UI Layer
    X.globalAlpha=1;
    X.fillStyle='rgba(255,255,255,0.5)'; 
    X.fillRect(W/2-1,H/2-1,2,2); // Crosshair
    
    for(var i=1; i<=4; i++){
      var bx = W/2 - 50 + (i-1)*25, by = H-25;
      X.fillStyle = 'rgba(0,0,0,0.5)';
      X.fillRect(bx, by, 20, 20);
      X.fillStyle = 'rgb('+COLS[i].join(',')+')';
      X.fillRect(bx+2, by+2, 16, 16);
      if(sel==i){
        X.lineWidth=2; X.strokeStyle='#fff';
        X.strokeRect(bx, by, 20, 20);
      }
    }
    
    X.fillStyle='#fff'; X.font="10px sans-serif"; 
    X.fillText("1-4 to Select Block", 5, H-5);
  }, 33);
  })();
  </script>