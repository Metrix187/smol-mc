<!doctype html><body style=margin:0;overflow:hidden><canvas id=c style=width:100%;height:100%;image-rendering:pixelated><script>(function(){var C=c,X=C.getContext("2d"),W=C.width=256,H=C.height=192,M=Math,S=M.sin,O=M.cos,A=M.abs,F=M.floor,SZ=64,SZ2=SZ*SZ,map=new Uint8Array(SZ**3),px=32,py=60,pz=32,yaw=0,pit=-.4,vx=0,vy=0,vz=0,K={},mx,my,mz,lx,ly,lz,face,id,sel=1,COLS=[[0,0,0],[100,200,50],[120,90,50],[140,140,140],[60,100,220]],i,j,k,h,t,spawnY=SZ-1,fov=.8,ray=(ox,oy,oz,ya,pi,act,uu,vv)=>{var dx=S(ya)*O(pi),dy=S(pi),dz=O(ya)*O(pi);if(!act){var rX=O(ya),rZ=-S(ya),uX=-S(pi)*S(ya),uY=O(pi),uZ=-S(pi)*O(ya);dx+=rX*uu*fov+uX*vv*fov*.75;dy+=uY*vv*fov*.75;dz+=rZ*uu*fov+uZ*vv*fov*.75}mx=F(ox);my=F(oy);mz=F(oz);if(map[mx+SZ*my+SZ2*mz]&&!act){id=map[mx+SZ*my+SZ2*mz];return{d:.1,dx,dy,dz}}var stepX=dx<0?-1:1,stepY=dy<0?-1:1,stepZ=dz<0?-1:1,dX=A(1/dx),dY=A(1/dy),dZ=A(1/dz),sdX=(stepX>0?mx+1-ox:ox-mx)*dX,sdY=(stepY>0?my+1-oy:oy-my)*dY,sdZ=(stepZ>0?mz+1-oz:oz-mz)*dZ;id=0;var dist=0;lx=mx;ly=my;lz=mz;while(dist<60){if(sdX<sdY&&sdX<sdZ){sdX+=dX;lx=mx;mx+=stepX;face=0;dist=sdX-dX}else if(sdY<sdZ){sdY+=dY;ly=my;my+=stepY;face=1;dist=sdY-dY}else{sdZ+=dZ;lz=mz;mz+=stepZ;face=2;dist=sdZ-dZ}if(mx<0||mx>=SZ||my<0||my>=SZ||mz<0||mz>=SZ)break;var b=map[mx+SZ*my+SZ2*mz];if(b){id=b;return{d:dist,dx,dy,dz}}}return{d:0,dx,dy,dz}},box=(x,y,z,bx,by,bz)=>x>bx-.3&&x<bx+1.3&&y>by-1.5&&y<by+.5&&z>bz-.3&&z<bz+1.3,col=(x,y,z)=>{if(x<0||x>=SZ||y<0||y>=SZ||z<0||z>=SZ)return 1;var b=map[F(x)+SZ*F(y)+SZ2*F(z)];return b&&b!=4},move=(dx,dy,dz)=>{if(!col(px+dx,py,pz-.3)&&!col(px+dx,py,pz+.3)&&!col(px+dx,py-1,pz-.3)&&!col(px+dx,py-1,pz+.3))px+=dx;else vx=0;if(!col(px-.3,py,pz+dz)&&!col(px+.3,py,pz+dz)&&!col(px-.3,py-1,pz+dz)&&!col(px+.3,py-1,pz+dz))pz+=dz;else vz=0;var yOff=dy>0?0:-1.5;if(!col(px-.3,py+dy+yOff,pz-.3)&&!col(px+.3,py+dy+yOff,pz-.3)&&!col(px+.3,py+dy+yOff,pz+.3)&&!col(px-.3,py+dy+yOff,pz+.3))py+=dy;else{if(dy<0)K.gr=1;vy=0}};for(i=0;i<SZ;i++)for(k=0;k<SZ;k++){h=28+F(8*S(i/12)+6*O(k/10)+5*S((i+k)/8));for(j=0;j<SZ;j++){t=0;if(j<h)t=j==h-1?1:j>h-5?2:3;else if(j<34)t=4;map[i+SZ*j+SZ2*k]=t}}while(spawnY>0&&!map[32+SZ*spawnY+SZ2*32])spawnY--;py=spawnY+2.5;onkeydown=e=>{K[e.keyCode]=1;if(e.key=="r"||e.key=="R"){px=pz=32;py=spawnY+5;vy=0}if(e.key>0&&e.key<5)sel=+e.key};onkeyup=e=>K[e.keyCode]=0;onmousemove=e=>{if(document.pointerLockElement){yaw+=e.movementX*.003;pit-=e.movementY*.003;pit=M.max(-1.5,M.min(1.5,pit))}};onmousedown=e=>{if(!document.pointerLockElement)return C.requestPointerLock();ray(px,py,pz,yaw,pit,1);if(id){var idx=mx+SZ*my+SZ2*mz,lidx=lx+SZ*ly+SZ2*lz;if(e.button==2&&!box(px,py,pz,lx,ly,lz)&&id!=4)map[lidx]=sel;if(e.button==0&&id!=4)map[idx]=0}};setInterval(()=>{var fwd=K[87]?1:K[83]?-1:0,strafe=K[68]?1:K[65]?-1:0;vx+=(S(yaw)*fwd+O(yaw)*strafe)*.02;vz+=(O(yaw)*fwd-S(yaw)*strafe)*.02;vy-=.015;if(K[32]&&K.gr){vy=.25;K.gr=0}move(vx,vy,vz);vx*=.8;vz*=.8;var img=X.createImageData(W,H),dt=img.data,x,y;for(x=0;x<W;x+=2)for(y=0;y<H;y+=2){var r=ray(px,py,pz,yaw,pit,0,(x/W-.5)*2,-(y/H-.5)*2),dist=r.d,R=0,G=0,B=0;if(id){var hx=px+r.dx*dist,hy=py+r.dy*dist,hz=pz+r.dz*dist,u=face==0?hz:hx,v=face==1?hz:hy,pat=(F(u*8)^F(v*8))&1?.85:1,col=COLS[id];if(id==1&&face!=1)col=COLS[2];var shad=1/(dist*.08+1);if(face==1)shad*=1.1;if(face==2)shad*=.8;if(id==3)pat=(F(hx*4)^F(hy*4)^F(hz*4))&1?.9:1;R=col[0]*pat*shad;G=col[1]*pat*shad;B=col[2]*pat*shad}else{var sun=M.pow(M.max(0,r.dx*.2+r.dy*.9+r.dz*.2),30),sky=M.max(0,1-(r.dy+.5));R=100*sky+sun*255;G=180*sky+sun*255;B=255*sky+sun*200}var idx=(x+y*W)*4,idx2=idx+W*4;dt[idx]=dt[idx+4]=dt[idx2]=dt[idx2+4]=R;dt[idx+1]=dt[idx+5]=dt[idx2+1]=dt[idx2+5]=G;dt[idx+2]=dt[idx+6]=dt[idx2+2]=dt[idx2+6]=B;dt[idx+3]=dt[idx+7]=dt[idx2+3]=dt[idx2+7]=255}X.putImageData(img,0,0);X.fillStyle="rgba(255,255,255,.5)";X.fillRect(W/2-1,H/2-1,2,2);for(i=1;i<=4;i++){var bx=W/2-50+(i-1)*25,by=H-25;X.fillStyle="rgba(0,0,0,.5)";X.fillRect(bx,by,20,20);X.fillStyle="rgb("+COLS[i]+")";X.fillRect(bx+2,by+2,16,16);if(sel==i){X.lineWidth=2;X.strokeStyle="#fff";X.strokeRect(bx,by,20,20)}}},33)})();</script>